PMA スクリプト説明
=================

想定では PMA と呼ばれるサブシステムは複数サーバに設置される 「スタブとスケルトン」 における スタブ の役割を担う．
ruby 1.8 で書かれている．

crontab での設定
```
*/2 * * * * ruby /opt/sabakan/hosting/script/pma/pma.rb; ruby /opt/sabakan/hosting/script/pma/pma_notifier.rb
```

## 共通部分

設置に時間がかかるため， /tmp/.pmalock というロックファイルを作成して重複稼動を防ぐ．

pne.jp は https で運用していて， api もすべて https になっている．
また ruby で ssl 経由ではその証明書を指定しなければいけないようなのでその設定をしている．

## pma.rb 

ディレクトリを走査して，存在している SNS のリストを取得．
/api/server/detail API によって 指定されたホスト名のサーバにある SNS（ドメイン） のリストを取得する．
API から取得された SNS のリストと既存の SNS のリストを比較し，既存の SNS に無いものがあればインストールスクリプトを起動する処理を行
インストール処理が終わった後に，メール通知を行うためにパスワードを送信している（正直ありえないので修正したいが…）


コメントアウトされている部分は，API から取得された SNS のリストには存在しないが既存の SNS にはあるものがある場合に削除をする予定だった処理．実装当時，このあたりの API が不確定だったため不意に削除されることを恐れてコメントアウトしてる．

master では修正されているし，入力上ありえないがドメイン名に ; やコマンドが入っている場合に実行されてしまうコマンドインジェクション脆弱性が存在する可能性がある


## pma_notifier.rb

/api/server/update API によって 指定されたホスト名のサーバ の状態をアップデートする

（なんで分けたかはよく覚えていない）
